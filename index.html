<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“æ³¨åŠ›</title>
    <style>
        :root {
            /* ç™½å¤©æ¨¡å¼å˜é‡ */
            --primary-color: #4a90e2;
            --work-color: #d9534f;
            --break-color: #5cb85c;
            --bg-color: #f5f7fa;
            --card-bg: #ffffff;
            --text-color: #333;
            --item-bg: #f8f9fa;
            --item-title-color: #2c3e50;
            --item-text-color: #666;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --tomato-bg: #e0e0e0;
            --btn-reset-bg: #e0e0e0;
            --btn-reset-color: #333;
        }

        /* å¤œé—´æ¨¡å¼å˜é‡ */
        body.dark-mode {
            --primary-color: #64b5f6;
            --work-color: #ef5350;
            --break-color: #66bb6a;
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --item-bg: #2d2d2d;
            --item-title-color: #e0e0e0;
            --item-text-color: #aaaaaa;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            --tomato-bg: #424242;
            --btn-reset-bg: #424242;
            --btn-reset-color: #e0e0e0;
        }

        ms: center;
            padding: 10px;
            overscroll-behavior: none; /* ç¦æ­¢æ©¡çš®ç­‹æ•ˆæœ */
        }

        .container {
            width: 100%;
            max-width: 1200px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* æ‰‹æœºç«–å±å¸ƒå±€ */
        @media (max-width: 767px) {
            .container {
                display: flex;
                flex-direction: column;
            }

            /* æ—¶é’ŸåŒºåŸŸç½®é¡¶ï¼Œå‹ç¼©é«˜åº¦ */
            .clock-card {
                flex: 0 0 auto; /* ä¸ä¼¸ç¼© */
                padding: 12px !important;
                display: flex;
                flex-direction: column; /* ä¿æŒç«–å‘ï¼Œä½†æ›´ç´§å‡‘ */
                justify-content: center;
                align-items: center;
                gap: 5px;
            }
            
            .clock-card h2 {
                display: none; /* æ‰‹æœºç«¯éšè—æ ‡é¢˜èŠ‚çœç©ºé—´ */
            }

            .timer-area {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 5px;
            }

            .timer-display {
                font-size: 3rem !important;
                margin: 5px 0 !important;
                line-height: 1;
            }

            .status-badge {
                margin: 0;
                font-size: 0.8rem;
                padding: 4px 10px;
            }

            .controls {
                margin: 5px 0 10px 0 !important;
            }
            
            button {
                padding: 6px 12px;
                font-size: 0.9rem;
            }

            /* ç•ªèŒ„ç»Ÿè®¡åŒºåŸŸ */
            .stats-wrapper {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                margin-top: 0;
                gap: 5px;
            }
            
            .stats-label {
                display: none;
            }

            .pomodoro-stats {
                margin: 0 !important;
                gap: 4px !important;
            }
            
            .tomato {
                width: 12px !important;
                height: 12px !important;
            }
            .tomato:nth-child(4n) {
                margin-right: 4px !important;
            }

            /* è­¦ç¤ºç‰ŒåŒºåŸŸï¼šè‡ªé€‚åº”é«˜åº¦ï¼Œä¸å¼ºè¡Œæ’‘æ»¡ */
            .board-card {
                flex: 0 1 auto; /* å…è®¸æ ¹æ®å†…å®¹è°ƒæ•´é«˜åº¦ï¼Œä¹Ÿå…è®¸å‹ç¼© */
                overflow: hidden; /* å†…éƒ¨æº¢å‡ºéšè—æˆ–æ»šåŠ¨ */
                display: flex;
                flex-direction: column;
                padding: 12px !important;
                max-height: 100%; /* é˜²æ­¢æº¢å‡ºçˆ¶å®¹å™¨ */
            }

            .board-card h1 {
                font-size: 1.2rem !important;
                margin-bottom: 10px !important;
                flex: 0 0 auto;
            }

            .board-list {
                flex: 1;
                overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶å†…éƒ¨æ»šåŠ¨ */
                display: grid;
                grid-template-columns: repeat(2, 1fr); /* å¼ºåˆ¶åŒåˆ— */
                gap: 8px !important;
                align-content: start;
                overscroll-behavior: contain; /* é˜²æ­¢æ»šåŠ¨é“¾ */
            }

            .board-item {
                padding: 8px !important;
                font-size: 0.85rem !important;
                border-left-width: 3px !important;
            }

            .board-item strong {
                font-size: 1em !important;
                margin-bottom: 2px !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .board-item span {
                font-size: 0.8em !important;
                line-height: 1.2;
                display: -webkit-box;
                -webkit-line-clamp: 2; /* é™åˆ¶æ˜¾ç¤ºä¸¤è¡Œ */
                -webkit-box-orient: vertical;
                overflow: hidden;
            }
        }

        /* å¤§å±å¹•å¸ƒå±€ä¿æŒä¸å˜ï¼Œå¾®è°ƒé«˜åº¦é€‚é… */
        @media (min-width: 768px) {
            .container {
                display: grid;
                grid-template-columns: 2fr 1fr;
                grid-template-rows: 100%;
                align-items: stretch; /* æ‹‰ä¼¸å¡«æ»¡é«˜åº¦ */
            }

            .card {
                height: 100%;
                overflow-y: auto;
            }
            
            .clock-card {
                justify-content: center;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
            overflow-y: auto;
            overscroll-behavior: contain;
        }

        h1, h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            width: 100%;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .gold-blink {
            color: #ff0000;
            animation: goldBlink 1.5s infinite;
        }

        @keyframes goldBlink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .progress-bar-bg {
            width: 100%;
            height: 12px;
            background-color: var(--work-color); /* çº¢è‰²èƒŒæ™¯ï¼Œä»£è¡¨æµé€çš„æ—¶é—´ */
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: flex-end; /* è®©è¿›åº¦æ¡é å³ï¼Œå®ç°å·¦ä¾§å‡å°‘çš„æ•ˆæœ */
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--break-color));
            border-radius: 0 6px 6px 0; /* å·¦ä¾§ç›´è§’ï¼Œå³ä¾§åœ†è§’ï¼Œè¡”æ¥æ›´è‡ªç„¶ */
            width: 0%;
            transition: width 1s ease-in-out;
            position: relative;
        }

        /* é—ªå…‰ç‰¹æ•ˆ */
        .progress-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(
                90deg,
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.3) 50%,
                rgba(255,255,255,0) 100%
            );
            transform: skewX(-20deg) translateX(-150%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            100% {
                transform: skewX(-20deg) translateX(150%);
            }
        }

        /* è­¦ç¤ºç‰Œæ ·å¼ */
        .board-list {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* é»˜è®¤åŒåˆ—å¸ƒå±€ */
            gap: 15px;
        }

        @media (min-width: 600px) and (max-width: 767px) {
            .board-list {
                grid-template-columns: repeat(3, 1fr); /* å¹³æ¿ç«–å±å¯èƒ½æ”¾ä¸‹3åˆ— */
            }
        }
        
        @media (min-width: 768px) {
            .board-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .board-item {
            background: var(--item-bg);
            border-left: 4px solid var(--primary-color);
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 1rem;
            display: flex;
            flex-direction: column;
        }

        .board-item strong {
            font-size: 1.1em;
            color: var(--item-title-color);
            margin-bottom: 4px;
        }

        .board-item span {
            font-size: 0.9em;
            color: var(--item-text-color);
        }

        /* ç•ªèŒ„æ—¶é’Ÿæ ·å¼ */
        .clock-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* position: sticky; */ /* ä¸€å±å¸ƒå±€ä¸éœ€è¦ sticky */
            /* top: 20px; */
        }

        .timer-display {
            font-size: 4rem;
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
            margin: 20px 0;
            color: var(--work-color);
            transition: color 0.3s;
        }

        .status-badge {
            background: var(--work-color);
            color: white;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 10px;
            transition: background 0.3s;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: opacity 0.2s, transform 0.1s;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-start {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-reset {
            background-color: var(--btn-reset-bg);
            color: var(--btn-reset-color);
        }

        .btn-theme {
            background-color: transparent;
            border: 2px solid var(--btn-reset-bg);
            color: var(--text-color);
        }

        .pomodoro-stats {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 10px;
        }

        .tomato {
            width: 18px;
            height: 18px;
            background-color: var(--tomato-bg);
            border-radius: 50%;
            transition: all 0.3s;
        }

        /* æ¯4ä¸ªä¸€ç»„å¢åŠ é—´è· */
        .tomato:nth-child(4n) {
            margin-right: 12px;
        }
        .tomato:last-child {
            margin-right: 0;
        }

        .tomato.active {
            background-color: var(--work-color);
            transform: scale(1.1);
        }

        /* çŠ¶æ€é¢œè‰²åˆ‡æ¢ */
        .mode-work .timer-display { color: var(--work-color); }
        .mode-work .status-badge { background-color: var(--work-color); }
        
        .mode-break .timer-display { color: var(--break-color); }
        .mode-break .status-badge { background-color: var(--break-color); }
    </style>
</head>
<body>

<div class="container">
    <!-- å‹‰åŠ±è­¦ç¤ºç‰ŒåŒºåŸŸ -->
    <div class="card board-card">
        <!-- <h1>âœ¨ ä¸“æ³¨åŠ›è­¦ç¤ºç‰Œ</h1> -->
        <div class="progress-container">
            <div class="progress-label">
                <span>ä¸–ç•Œæœ«æ—¥(<span class="gold-blink">æ­‡å°½å…¨åŠ›,å¾è¡Œå¼—é—´,æˆ–åå…ˆè‡³ç„‰</span>)</span>
                <div>
                    <span id="elapsedText" style="color: var(--work-color); margin-right: 15px;">å·²è¿‡: 0%</span>
                    <span id="progressText">0%</span>
                </div>
            </div>
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progressBar"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-top: 4px;">
                <span id="startDateDisplay"></span>
                <span id="endDateDisplay"></span>
            </div>
        </div>

        <div class="board-list">
            <div class="board-item">
                <strong>äºŒåå››å²</strong>
                <span>è¿˜æ²¡å¼€å§‹çœ‹,æœªæ¥èŠ±ä¸ªå‡ å¹´å»çœ‹</span>
            </div>
            <div class="board-item">
                <strong>èµ„æ²»é€šé‰´</strong>
                <span>å·²ç»çœ‹åˆ°æ±‰æ™¯å¸äº†,çœŸä¸é”™</span>
            </div>
            <div class="board-item">
                <strong>å»ç½‘å§ç©ç©</strong>
                <span>å®¶é™„è¿‘æœ‰ä¸ªç½‘å§å«ç½‘é±¼,å¥½æƒ³å»</span>
            </div>
            <div class="board-item">
                <strong>æƒ³é”»ç‚¼èº«ä½“</strong>
                <span>åŸæœ¬å°±æœ‰èº«é«˜ä¼˜åŠ¿,åªæ˜¯æ²¡æœ‰æ—¶é—´</span>
            </div>
            <div class="board-item">
                <strong>å‘¨æœ«æ¸¸ç©</strong>
                <span>æœ‰æ—¶é—´æœ‰é’±,ä¸¤å¤©ç›´æ¥åé£æœºèµ°èµ·</span>
            </div>
            <div class="board-item">
                <strong>å•æœº,è¡—æœº,ç½‘æ¸¸</strong>
                <span>å¾—éœ€è¦æ—¶é—´å’Œé‡‘é’±,ä¸€å®šä¼šæœ‰çš„,ä¸€å®š</span>
            </div>
            <div class="board-item">
                <strong>å­¦å­¦å¨è‰º,é«˜å°”å¤«ï¼Ÿ</strong>
                <span>æœ‰å…´è¶£å°±å»,æ˜¯å§æ²¡å‹åŠ›</span>
            </div>
            <div class="board-item">
                <strong>è·‘è½¦è·‘è½¦</strong>
                <span>ä¸°ç”°86å¥½çœ‹åˆä¸è´µ</span>
            </div>
            <div class="board-item">
                <strong>è‡ªç„¶é†’,9ç‚¹å†å»ä¸Šç­</strong>
                <span>ç¡åˆ°è‡ªç„¶é†’ï¼Œå‡ºé—¨10åˆ†é’Ÿåˆ°å•ä½,å¤šä¹ˆçˆ½</span>
            </div>
            <div class="board-item">
                <strong>æƒ³æƒ³æƒ³æƒ³</strong>
                <span>å“ˆå“ˆä¸èƒ½è¯´,å“ˆå“ˆä¸èƒ½è¯´</span>
            </div>
            <div class="board-item">
                <strong>é™ªå®¶äºº</strong>
                <span>æœ‰å¤§æŠŠæ—¶é—´é™ªå®¶äºº,é™ªBB,å®¶é•¿ä¼šä¹Ÿèƒ½å»</span>
            </div>
            <div class="board-item">
                <strong>æ—©ç‚¹é€€ä¼‘</strong>
                <span>å¬è¯´é€€ä¼‘é‡‘å¾ˆå¤šï¼Œå“ˆå“ˆ</span>
            </div>
        </div>
    </div>

    <!-- ç•ªèŒ„æ—¶é’ŸåŒºåŸŸ -->
    <div class="card clock-card mode-work" id="clockCard">
        <h2>ğŸ… æ—¶é’Ÿ</h2>
        <div class="timer-area">
            <div class="status-badge" id="statusText">å­¦ä¹ ä¸­ - ä¿æŒä¸“æ³¨</div>
            <div class="timer-display" id="timer">25:00</div>
        </div>
        
        <div class="controls">
            <button class="btn-start" id="startBtn" onclick="toggleTimer()">å¼€å§‹è®¡æ—¶</button>
            <button class="btn-reset" onclick="resetTimer()">é‡ç½®</button>
            <button class="btn-theme" onclick="toggleTheme()">ä¸»é¢˜</button>
        </div>

        <div class="stats-wrapper">
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;" class="stats-label">ä»Šæ—¥ç•ªèŒ„æ•°</div>
            <div class="pomodoro-stats" id="pomodoroStats">
                <!-- JS åŠ¨æ€ç”Ÿæˆ 20 ä¸ªç•ªèŒ„ -->
            </div>
        </div>
    </div>
</div>

<script>
    // é…ç½®
    const WORK_TIME = 25 * 60; // 25åˆ†é’Ÿ
    const SHORT_BREAK = 5 * 60; // 5åˆ†é’Ÿ
    const LONG_BREAK = 20 * 60; // 20åˆ†é’Ÿ
    const CYCLES_BEFORE_LONG_BREAK = 4;
    const START_DATE_STR = '2025-12-09';
    const END_DATE_STR = '2026-12-01';
    const THEME_STORAGE_KEY = 'theme-mode';

    // çŠ¶æ€å˜é‡
    let timeLeft = WORK_TIME;
    let timerId = null;
    let isRunning = false;
    let currentMode = 'work'; // 'work', 'shortBreak', 'longBreak'
    let completedPomodoros = 0;
    let isAutoTheme = true;

    // Load persisted data
    loadPomodoroData();

    // DOM å…ƒç´ 
    const timerDisplay = document.getElementById('timer');
    const startBtn = document.getElementById('startBtn');
    const statusText = document.getElementById('statusText');
    const clockCard = document.getElementById('clockCard');
    const statsContainer = document.getElementById('pomodoroStats');

    // åˆå§‹åŒ–æ˜¾ç¤º
    applyStoredTheme();
    if (isAutoTheme) {
        checkTheme();
    }
    updateLifeProgress(); // è®¡ç®—å¹¶æ›´æ–°è¿›åº¦æ¡
    initStats();
    
    // å°è¯•åŠ è½½è®¡æ—¶å™¨çŠ¶æ€ï¼Œå¦‚æœæˆåŠŸåˆ™ä¸ä¼šæ‰§è¡Œé»˜è®¤çš„ updateDisplay å’Œ startTimer
    if (!loadTimerState()) {
        updateDisplay();
        updateStats();
        // è‡ªåŠ¨å¼€å§‹è®¡æ—¶ (é»˜è®¤è¡Œä¸º)
        startTimer();
    } else {
        // å¦‚æœåŠ è½½äº†çŠ¶æ€ï¼ŒupdateStats è¿˜æ˜¯éœ€è¦çš„
        updateStats();
    }
    
    // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡ä¸»é¢˜ (å¦‚æœç”¨æˆ·æ‰‹åŠ¨åˆ‡æ¢è¿‡ï¼Œåˆ™ä¸å†è‡ªåŠ¨æ£€æŸ¥)
    setInterval(() => {
        if (isAutoTheme) checkTheme();
    }, 60000);
    // æ¯å¤©æ›´æ–°ä¸€æ¬¡è¿›åº¦æ¡
    setInterval(updateLifeProgress, 86400000);

    function loadPomodoroData() {
        try {
            const data = JSON.parse(localStorage.getItem('pomodoroData'));
            const today = new Date().toISOString().split('T')[0];
            if (data && data.date === today) {
                completedPomodoros = data.count || 0;
            } else {
                completedPomodoros = 0;
                localStorage.setItem('pomodoroData', JSON.stringify({ date: today, count: 0 }));
            }
        } catch (e) {
            console.error('Failed to load data', e);
            completedPomodoros = 0;
        }
    }

    function savePomodoroData() {
        try {
            const today = new Date().toISOString().split('T')[0];
            localStorage.setItem('pomodoroData', JSON.stringify({ date: today, count: completedPomodoros }));
        } catch (e) {
            console.error('Failed to save data', e);
        }
    }

    function saveTimerState() {
        try {
            const state = {
                timeLeft: timeLeft,
                currentMode: currentMode,
                isRunning: isRunning,
                timestamp: Date.now()
            };
            localStorage.setItem('timerState', JSON.stringify(state));
        } catch (e) {
            console.error('Failed to save timer state', e);
        }
    }

    function loadTimerState() {
        try {
            const saved = JSON.parse(localStorage.getItem('timerState'));
            if (saved) {
                // æ¢å¤åŸºæœ¬çŠ¶æ€
                currentMode = saved.currentMode;
                // æ¢å¤ UI æ¨¡å¼ï¼ˆä½†ä¸é‡ç½®æ—¶é—´ï¼‰
                switchMode(currentMode, false);
                
                timeLeft = saved.timeLeft;
                const wasRunning = saved.isRunning;
                const lastTime = saved.timestamp;
                const now = Date.now();
                
                if (wasRunning) {
                    // è®¡ç®—ç¦»çº¿æµé€çš„æ—¶é—´
                    const elapsedSeconds = Math.floor((now - lastTime) / 1000);
                    timeLeft -= elapsedSeconds;
                    
                    if (timeLeft <= 0) {
                        // ç¦»çº¿æœŸé—´å€’è®¡æ—¶å·²ç»“æŸ
                        timeLeft = 0;
                        updateDisplay();
                        // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œå®Œæˆé€»è¾‘ï¼Œè®©ç”¨æˆ·çœ‹åˆ° 00:00
                        setTimeout(() => {
                            handleTimerComplete();
                        }, 500);
                    } else {
                        // ç»§ç»­è¿è¡Œ
                        updateDisplay();
                        startTimer();
                    }
                } else {
                    // æš‚åœçŠ¶æ€
                    isRunning = false;
                    startBtn.textContent = 'ç»§ç»­';
                    startBtn.style.backgroundColor = ''; // æ¢å¤é»˜è®¤è‰²
                    updateDisplay();
                    document.title = 'å·²æš‚åœ - ç•ªèŒ„æ—¶é’Ÿ';
                }
                return true; // åŠ è½½æˆåŠŸ
            }
        } catch (e) {
            console.error('Failed to load timer state', e);
        }
        return false; // åŠ è½½å¤±è´¥æˆ–æ— æ•°æ®
    }

    function updateLifeProgress() {
        const startDate = new Date(START_DATE_STR + 'T00:00:00').getTime();
        const endDate = new Date(END_DATE_STR + 'T00:00:00').getTime();
        const now = new Date().getTime();

        let percentage = 0;
        let elapsedPercentage = 0;
        
        if (now <= startDate) {
            percentage = 100; // è¿˜æ²¡å¼€å§‹ï¼Œå‰©ä½™ 100%
            elapsedPercentage = 0;
        } else if (now >= endDate) {
            percentage = 0;   // ç»“æŸäº†ï¼Œå‰©ä½™ 0%
            elapsedPercentage = 100;
        } else {
            const total = endDate - startDate;
            const remaining = endDate - now;
            const elapsed = now - startDate;
            
            percentage = (remaining / total) * 100;
            elapsedPercentage = (elapsed / total) * 100;
        }

        const pctStr = percentage.toFixed(2) + '%';
        const elapsedStr = elapsedPercentage.toFixed(2) + '%';
        
        document.getElementById('progressBar').style.width = pctStr;
        document.getElementById('progressText').textContent = pctStr;
        
        // æ›´æ–°çº¢è‰²åŒºåŸŸï¼ˆå·¦ä¾§ï¼‰æ˜¾ç¤ºçš„å·²è¿‡ç™¾åˆ†æ¯”
        const elapsedElem = document.getElementById('elapsedText');
        if (elapsedElem) {
            elapsedElem.textContent = 'å·²è¿‡: ' + elapsedStr;
        }

        // æ˜¾ç¤ºå¼€å§‹å’Œç»“æŸæ—¶é—´
        const startElem = document.getElementById('startDateDisplay');
        const endElem = document.getElementById('endDateDisplay');
        if (startElem) startElem.textContent = START_DATE_STR;
        if (endElem) endElem.textContent = END_DATE_STR;
    }

    function applyStoredTheme() {
        try {
            const stored = localStorage.getItem(THEME_STORAGE_KEY);
            if (stored === 'dark') {
                document.body.classList.add('dark-mode');
                isAutoTheme = false;
            } else if (stored === 'light') {
                document.body.classList.remove('dark-mode');
                isAutoTheme = false;
            }
        } catch (e) {}
    }

    function checkTheme() {
        const hour = new Date().getHours();
        // æ—©ä¸Š7ç‚¹(å«) åˆ° æ™šä¸Š18ç‚¹(ä¸å«) ä¸ºç™½å¤©æ¨¡å¼
        const isDayTime = hour >= 7 && hour < 18;
        
        if (isDayTime) {
            document.body.classList.remove('dark-mode');
        } else {
            document.body.classList.add('dark-mode');
        }
    }

    function toggleTheme() {
        isAutoTheme = false; // ç¦ç”¨è‡ªåŠ¨åˆ‡æ¢
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        try {
            localStorage.setItem(THEME_STORAGE_KEY, isDark ? 'dark' : 'light');
        } catch (e) {}
    }

    function initStats() {
        statsContainer.innerHTML = '';
        for (let i = 0; i < 20; i++) {
            const div = document.createElement('div');
            div.className = 'tomato';
            statsContainer.appendChild(div);
        }
    }

    function toggleTimer() {
        if (isRunning) {
            pauseTimer();
        } else {
            startTimer();
        }
    }

    function startTimer() {
        if (timerId) return;
        
        isRunning = true;
        startBtn.textContent = 'æš‚åœ';
        startBtn.style.backgroundColor = '#f0ad4e'; // æš‚åœæ—¶æ˜¾ç¤ºé»„è‰²
        
        // ç«‹å³ä¿å­˜ä¸€æ¬¡çŠ¶æ€
        saveTimerState();

        timerId = setInterval(() => {
            if (timeLeft > 0) {
                timeLeft--;
                updateDisplay();
                // ç½‘é¡µæ ‡é¢˜åŒæ­¥æ˜¾ç¤ºå€’è®¡æ—¶ï¼Œæ–¹ä¾¿åˆ‡æ¢æ ‡ç­¾é¡µæ—¶æŸ¥çœ‹
                document.title = `${formatTime(timeLeft)} - ${getStatusLabel()}`;
                // æ¯æ¬¡æ›´æ–°éƒ½ä¿å­˜çŠ¶æ€
                saveTimerState();
            } else {
                handleTimerComplete();
            }
        }, 1000);
    }

    function pauseTimer() {
        isRunning = false;
        clearInterval(timerId);
        timerId = null;
        startBtn.textContent = 'ç»§ç»­';
        startBtn.style.backgroundColor = ''; // æ¢å¤é»˜è®¤è‰²
        document.title = 'å·²æš‚åœ - ç•ªèŒ„æ—¶é’Ÿ';
        // ä¿å­˜æš‚åœçŠ¶æ€
        saveTimerState();
    }

    function resetTimer() {
        pauseTimer();
        
        // 1. é‡ç½®ç•ªèŒ„æ•°æ®
        completedPomodoros = 0;
        localStorage.removeItem('pomodoroData');
        updateStats();

        // 2. é‡ç½®è®¡æ—¶å™¨çŠ¶æ€ç¼“å­˜
        localStorage.removeItem('timerState');

        // 3. é‡ç½®ä¸º Work æ¨¡å¼åˆå§‹æ—¶é—´
        currentMode = 'work';
        timeLeft = WORK_TIME;
        
        // 4. é‡ç½® UI
        startBtn.textContent = 'å¼€å§‹è®¡æ—¶';
        statusText.textContent = 'å­¦ä¹ ä¸­ - ä¿æŒä¸“æ³¨';
        clockCard.className = 'card clock-card mode-work';
        
        updateDisplay();
        document.title = 'ä¸“æ³¨åŠ›';
        
        // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¸å†è°ƒç”¨ saveTimerState()ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å®ƒæ˜¯â€œå¹²å‡€â€çš„ã€‚
        // æˆ–è€…æˆ‘ä»¬å¯ä»¥ä¿å­˜ä¸€ä¸ªåˆå§‹çŠ¶æ€ï¼Œé˜²æ­¢åˆ·æ–°ååˆå›åˆ°ä¹‹å‰çš„çŠ¶æ€ï¼ˆå¦‚æœ clear æ²¡ç”Ÿæ•ˆçš„è¯ï¼Œä½† removeItem åº”è¯¥å¤Ÿäº†ï¼‰
        // ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬å¯ä»¥ä¿å­˜ä¸€ä¸ªâ€œæœªå¼€å§‹â€çš„åˆå§‹çŠ¶æ€
        saveTimerState();
    }

    function handleTimerComplete() {
        pauseTimer();
        playNotificationSound();

        if (currentMode === 'work') {
            completedPomodoros++;
            updateStats();
            savePomodoroData(); // ä¿å­˜æ•°æ®
            
            // åˆ¤æ–­è¿›å…¥å“ªç§ä¼‘æ¯
            if (completedPomodoros % CYCLES_BEFORE_LONG_BREAK === 0) {
                switchMode('longBreak');
            } else {
                switchMode('shortBreak');
            }
        } else {
            // ä¼‘æ¯ç»“æŸï¼Œå›åˆ°å·¥ä½œ
            switchMode('work');
        }
        
        // è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®
        startTimer();
    }

    function switchMode(mode, resetTime = true) {
        currentMode = mode;
        clockCard.className = 'card clock-card'; // é‡ç½®ç±»å
        
        if (mode === 'work') {
            if (resetTime) timeLeft = WORK_TIME;
            statusText.textContent = 'å­¦ä¹ ä¸­ - ä¿æŒä¸“æ³¨';
            clockCard.classList.add('mode-work');
        } else if (mode === 'shortBreak') {
            if (resetTime) timeLeft = SHORT_BREAK;
            statusText.textContent = 'ä¼‘æ¯ä¸­ - æ”¾æ¾ä¸€ä¸‹';
            clockCard.classList.add('mode-break');
        } else if (mode === 'longBreak') {
            if (resetTime) timeLeft = LONG_BREAK;
            statusText.textContent = 'é•¿ä¼‘æ¯ - æ·±åº¦æ”¾æ¾';
            clockCard.classList.add('mode-break');
        }
        updateDisplay();
    }

    function updateDisplay() {
        timerDisplay.textContent = formatTime(timeLeft);
    }

    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function getStatusLabel() {
        if (currentMode === 'work') return 'å­¦ä¹ ä¸­';
        return 'ä¼‘æ¯ä¸­';
    }

    function updateStats() {
        const tomatoes = statsContainer.children;
        for (let i = 0; i < tomatoes.length; i++) {
            if (i < completedPomodoros) {
                tomatoes[i].classList.add('active');
            } else {
                tomatoes[i].classList.remove('active');
            }
        }
    }

    function playNotificationSound() {
        // ç®€å•çš„æç¤ºéŸ³é€»è¾‘ï¼Œä½¿ç”¨ Web Audio API ç”Ÿæˆç®€å•çš„ Beep å£°
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                
                osc.type = 'sine';
                osc.frequency.value = 440; // A4
                gain.gain.value = 0.1;
                
                osc.start();
                setTimeout(() => {
                    osc.stop();
                    // å†æ¬¡æ’­æ”¾ä¸¤å£°
                    setTimeout(() => {
                        const osc2 = ctx.createOscillator();
                        const gain2 = ctx.createGain();
                        osc2.connect(gain2);
                        gain2.connect(ctx.destination);
                        osc2.frequency.value = 523.25; // C5
                        gain2.gain.value = 0.1;
                        osc2.start();
                        setTimeout(() => osc2.stop(), 200);
                    }, 300);
                }, 200);
            }
        } catch (e) {
            console.log('Audio playback failed', e);
        }
    }
</script>

</body>
</html>

